<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tip Calculator</title>
  <style>
    :root {
      --bg: #f5f7fb;
      --card: #ffffff;
      --text: #1f2937;
      --muted: #6b7280;
      --primary: #0f766e;
      --primary-hover: #0b5f58;
      --border: #d1d5db;
      --danger: #b91c1c;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Segoe UI", "Noto Sans KR", sans-serif;
      background: radial-gradient(circle at top right, #dbeafe, var(--bg) 55%);
      color: var(--text);
      min-height: 100vh;
      display: grid;
      place-items: center;
      padding: 24px;
    }
    .container {
      width: min(760px, 100%);
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.06);
    }
    h1 { margin: 0 0 8px; font-size: 1.5rem; }
    p { margin: 0 0 20px; color: var(--muted); line-height: 1.5; }
    .grid { display: grid; grid-template-columns: 1fr; gap: 12px; margin-bottom: 18px; }
    .field { border: 1px solid var(--border); border-radius: 10px; padding: 12px; background: #fafafa; }
    .field label { display: block; font-weight: 600; margin-bottom: 6px; }
    input[type="file"] { width: 100%; }
    button {
      border: 0;
      background: var(--primary);
      color: #fff;
      font-size: 1rem;
      padding: 12px 16px;
      border-radius: 10px;
      cursor: pointer;
      width: 100%;
      font-weight: 700;
    }
    button:hover { background: var(--primary-hover); }
    button:disabled { background: #9ca3af; cursor: not-allowed; }
    #status {
      margin-top: 14px;
      padding: 10px 12px;
      border-radius: 8px;
      background: #ecfeff;
      border: 1px solid #99f6e4;
      color: #0f766e;
      font-size: 0.95rem;
      white-space: pre-line;
    }
    #status.error { background: #fef2f2; border-color: #fecaca; color: var(--danger); }
  </style>
</head>
<body>
  <main class="container">
    <h1>Staff Tip Settlement Generator</h1>
    <p>Upload Sales.csv, HallWorkingHours.csv, and KitchenWorkingHours.csv to download Result.xlsx. (Hall 70%, Kitchen 30%)</p>

    <div class="grid">
      <div class="field">
        <label for="salesFile">1) Sales.csv</label>
        <input id="salesFile" type="file" accept=".csv,text/csv" />
      </div>
      <div class="field">
        <label for="hallFile">2) HallWorkingHours.csv</label>
        <input id="hallFile" type="file" accept=".csv,text/csv" />
      </div>
      <div class="field">
        <label for="kitchenFile">3) KitchenWorkingHours.csv</label>
        <input id="kitchenFile" type="file" accept=".csv,text/csv" />
      </div>
    </div>

    <button id="runBtn">Calculate and Download Result.xlsx</button>
    <div id="status">Select all 3 files and click the button.</div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script>
    const ACCESS_PASSWORD = '1225';

    function requirePassword() {
      let attempts = 0;
      while (attempts < 3) {
        const input = window.prompt('Enter password to access this page:');
        if (input === ACCESS_PASSWORD) return true;
        if (input === null) break;
        attempts += 1;
        window.alert('Incorrect password.');
      }
      return false;
    }

    if (!requirePassword()) {
      document.body.innerHTML = '<main style=\"min-height:100vh;display:grid;place-items:center;font-family:Segoe UI,sans-serif;\"><p>Access denied.</p></main>';
      throw new Error('Unauthorized access');
    }

    const HALL_RATIO = 0.7;
    const KITCHEN_RATIO = 0.3;

    const salesInput = document.getElementById('salesFile');
    const hallInput = document.getElementById('hallFile');
    const kitchenInput = document.getElementById('kitchenFile');
    const runBtn = document.getElementById('runBtn');
    const statusEl = document.getElementById('status');

    function setStatus(message, isError = false) {
      statusEl.textContent = message;
      statusEl.classList.toggle('error', isError);
    }

    function parseCSV(text) {
      const rows = [];
      let row = [];
      let value = '';
      let inQuotes = false;

      for (let i = 0; i < text.length; i += 1) {
        const ch = text[i];
        const next = text[i + 1];
        if (ch === '"') {
          if (inQuotes && next === '"') {
            value += '"';
            i += 1;
          } else {
            inQuotes = !inQuotes;
          }
        } else if (ch === ',' && !inQuotes) {
          row.push(value);
          value = '';
        } else if ((ch === '\n' || ch === '\r') && !inQuotes) {
          if (ch === '\r' && next === '\n') i += 1;
          row.push(value);
          rows.push(row);
          row = [];
          value = '';
        } else {
          value += ch;
        }
      }
      if (value.length > 0 || row.length > 0) {
        row.push(value);
        rows.push(row);
      }
      return rows;
    }

    function clean(s) { return String(s || '').trim(); }

    function parseMoney(raw) {
      const s = clean(raw).replace(/\$/g, '').replace(/,/g, '').replace(/\s/g, '');
      if (!s) return 0;
      if (/^\(.*\)$/.test(s)) return -Number(s.slice(1, -1));
      return Number(s) || 0;
    }

    function parseDateFlexible(value) {
      const s = clean(value);
      if (!s) return null;
      const ymd = s.match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/);
      if (ymd) return new Date(Number(ymd[1]), Number(ymd[2]) - 1, Number(ymd[3]), 12, 0, 0);
      const mdy = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
      if (mdy) return new Date(Number(mdy[3]), Number(mdy[1]) - 1, Number(mdy[2]), 12, 0, 0);
      const dt = new Date(s);
      if (!Number.isNaN(dt.getTime())) return new Date(dt.getFullYear(), dt.getMonth(), dt.getDate(), 12, 0, 0);
      return null;
    }

    function toDateKey(dateObj) {
      const y = dateObj.getFullYear();
      const m = String(dateObj.getMonth() + 1).padStart(2, '0');
      const d = String(dateObj.getDate()).padStart(2, '0');
      return `${y}-${m}-${d}`;
    }

    function round2(n) { return Math.round((n + Number.EPSILON) * 100) / 100; }

    function parseSalesTips(csvText) {
      const rows = parseCSV(csvText).filter(r => r.some(c => clean(c) !== ''));
      const header = rows[0] || [];
      const tipRow = rows.find(r => clean(r[0]).toLowerCase() === 'tip');
      if (!tipRow) throw new Error('Could not find the Tip row in Sales.csv.');

      const tipByDate = new Map();
      for (let i = 1; i < header.length; i += 1) {
        const dateObj = parseDateFlexible(header[i]);
        if (!dateObj) continue;
        tipByDate.set(toDateKey(dateObj), parseMoney(tipRow[i]));
      }
      return tipByDate;
    }

    function parseWorkingHours(csvText) {
      const rows = parseCSV(csvText).filter(r => r.some(c => clean(c) !== ''));
      const header = (rows[0] || []).map(clean);
      const employeeIdx = header.indexOf('Employee Name');
      const dateIdx = header.indexOf('Date');
      const hoursIdx = header.indexOf('Total Hours');
      if (employeeIdx < 0 || dateIdx < 0 || hoursIdx < 0) {
        throw new Error('Could not find required columns in working-hours CSV (Employee Name/Date/Total Hours).');
      }

      const byDate = new Map();
      for (let i = 1; i < rows.length; i += 1) {
        const row = rows[i];
        const name = clean(row[employeeIdx]);
        const dateObj = parseDateFlexible(row[dateIdx]);
        const hours = Number(clean(row[hoursIdx])) || 0;
        if (!name || !dateObj || hours <= 0) continue;

        const key = toDateKey(dateObj);
        if (!byDate.has(key)) byDate.set(key, new Map());
        byDate.get(key).set(name, (byDate.get(key).get(name) || 0) + hours);
      }
      return byDate;
    }

    function makeRows(tipByDate, hallHoursByDate, kitchenHoursByDate) {
      const detailRows = [];
      const totalByEmployee = new Map();
      const warnings = [];
      const dates = [...tipByDate.keys()].sort((a, b) => a.localeCompare(b));

      function distribute(dateKey, teamName, teamTip, hoursMap) {
        const entries = [...(hoursMap ? hoursMap.entries() : [])].filter(([, h]) => h > 0);
        const totalHours = entries.reduce((s, [, h]) => s + h, 0);
        if (teamTip > 0 && totalHours <= 0) {
          warnings.push(`${dateKey} ${teamName}: No working hours found, so ${teamTip.toFixed(2)} USD could not be distributed.`);
          return;
        }
        for (const [name, hours] of entries) {
          const tip = round2((hours / totalHours) * teamTip);
          detailRows.push({ Date: dateKey, Team: teamName, Employee: name, Hours: round2(hours), 'Tip Amount (USD)': tip });
          totalByEmployee.set(name, round2((totalByEmployee.get(name) || 0) + tip));
        }
      }

      for (const dateKey of dates) {
        const totalTip = tipByDate.get(dateKey) || 0;
        distribute(dateKey, 'Hall', totalTip * HALL_RATIO, hallHoursByDate.get(dateKey));
        distribute(dateKey, 'Kitchen', totalTip * KITCHEN_RATIO, kitchenHoursByDate.get(dateKey));
      }

      detailRows.sort((a, b) => (a.Date !== b.Date ? a.Date.localeCompare(b.Date) : (a.Team !== b.Team ? a.Team.localeCompare(b.Team) : a.Employee.localeCompare(b.Employee))));

      const summaryRows = [...totalByEmployee.entries()]
        .sort((a, b) => a[0].localeCompare(b[0]))
        .map(([name, total]) => ({ Employee: name, '2-Week Total Tip (USD)': round2(total) }));

      return { detailRows, summaryRows, warnings };
    }

    async function readFile(input, label) {
      const file = input.files[0];
      if (!file) throw new Error(`Please select ${label}.`);
      return file.text();
    }

    runBtn.addEventListener('click', async () => {
      try {
        if (!window.XLSX) throw new Error('Failed to load Excel library (check internet connection).');
        runBtn.disabled = true;
        setStatus('Reading files...');

        const [salesText, hallText, kitchenText] = await Promise.all([
          readFile(salesInput, 'Sales.csv'),
          readFile(hallInput, 'HallWorkingHours.csv'),
          readFile(kitchenInput, 'KitchenWorkingHours.csv')
        ]);

        setStatus('Calculating...');
        const tipByDate = parseSalesTips(salesText);
        const hallHoursByDate = parseWorkingHours(hallText);
        const kitchenHoursByDate = parseWorkingHours(kitchenText);
        const { detailRows, summaryRows, warnings } = makeRows(tipByDate, hallHoursByDate, kitchenHoursByDate);

        const wb = XLSX.utils.book_new();

        const sheet1 = XLSX.utils.json_to_sheet(detailRows);
        sheet1['!cols'] = [{ wch: 12 }, { wch: 10 }, { wch: 24 }, { wch: 10 }, { wch: 18 }];
        XLSX.utils.book_append_sheet(wb, sheet1, 'Daily Tips');

        const sheet2 = XLSX.utils.json_to_sheet(summaryRows);
        sheet2['!cols'] = [{ wch: 24 }, { wch: 20 }];
        XLSX.utils.book_append_sheet(wb, sheet2, '2-Week Summary');

        XLSX.writeFile(wb, 'Result.xlsx');

        const lines = [
          'Done: Result.xlsx created',
          `- Daily detail rows: ${detailRows.length}`,
          `- Employees in summary: ${summaryRows.length}`
        ];
        if (warnings.length) {
          lines.push('', '[Warnings]', ...warnings.slice(0, 10));
          if (warnings.length > 10) lines.push(`... and ${warnings.length - 10} more`);
        }
        setStatus(lines.join('\n'));
      } catch (err) {
        setStatus(`Error: ${err.message}`, true);
      } finally {
        runBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
